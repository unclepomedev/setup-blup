name: Test Action

on:
  push:
    branches: [main]
    paths-ignore: ['*.md']
  pull_request:
    branches: [main]
    paths-ignore: ['*.md']
  workflow_dispatch:

jobs:
  # -------------------------------------------------------------
  # Job 1: CLI only
  # -------------------------------------------------------------
  test-cli-only:
    name: Test CLI Install (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup blup (No Blender)
        uses: ./
        with:
          blender-version: ''

      - name: Verify blup version
        run: blup --version

  # -------------------------------------------------------------
  # Job 2: All OS / Blender install + cache
  # -------------------------------------------------------------
  test-full-install:
    name: Test Full Install (${{ matrix.os }})
    strategy:
      fail-fast: false
      matrix:
        os: [ubuntu-latest, windows-latest, macos-latest]
        blender-version: ['4.2.0', '5.0.0']

    runs-on: ${{ matrix.os }}

    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Blender ${{ matrix.blender-version }}
        uses: ./
        with:
          blender-version: ${{ matrix.blender-version }}
          cache: true

      - name: Verify Execution
        run: blup run -- --background --version

  # -------------------------------------------------------------
  # Job 3: daily: true
  # -------------------------------------------------------------
  test-daily:
    name: Test Daily Flag (Ubuntu)
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Setup Blender Daily
        uses: ./
        with:
          blender-version: 'daily'
          daily: 'true'
          cache: true

      - name: Verify Execution
        run: blup run -- --background --version

  # -------------------------------------------------------------
  # Job 4: .blender-version detection
  # -------------------------------------------------------------
  test-file-detection:
    name: Test .blender-version File Detection
    runs-on: ubuntu-latest
    steps:
      - uses: actions/checkout@de0fac2e4500dabe0009e67214ff5f5447ce83dd # v6

      - name: Create .blender-version file
        run: echo "4.5.0" > .blender-version

      - name: Setup blup (Auto-detect)
        uses: ./
        with:
          cache: true

      - name: Verify Auto-detection
        shell: bash
        run: |
          DETECTED=$(blup resolve)
          echo "Detected version: $DETECTED"
          
          if [ "$DETECTED" != "4.5.0" ]; then
            echo "::error::Auto-detection failed. Expected 4.5.0, got $DETECTED"
            exit 1
          fi

          blup run -- --background --version